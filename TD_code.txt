import json, TDJSON, TDFunctions

operation = parent().par.Op.eval()
print(operation)


def onValueChange(par, prev):
	operation = parent().par.Op.eval()
	if not operation:
		return
		
	# Get full schema and state
	full_schema = TDJSON.opToJSONOp(operation, extraAttrs=None, forceAttrLists=False, includeCustomPages=True, includeBuiltInPages=True)
	full_state = TDFunctions.getParInfo(operation, pattern='*', names=None, includeCustom=True, includeNonCustom=True)
	
	# 1) Send EVERYTHING without filtering
	schema = full_schema
	state = full_state
	
	name = str(operation).split("/")[-1]
	
	update_info = {
	  "type": "schema_update",
	  "id": str(operation.id), 
	  "title": name,
	  "schema": schema,
	  "state": state}
	
	op("websocket1").sendText(json.dumps(update_info))
	print(name, ": Sent full schema to websocket")
	return

# Called at end of frame with complete list of individual parameter changes.
# The changes are a list of named tuples, where each tuple is (Par, previous value)
def onValuesChanged(changes):
	for c in changes:
		# use par.eval() to get current value
		par = c.par
		prev = c.prev
	return

def onPulse(par):
	return

def onExpressionChange(par, val, prev):
	return

def onExportChange(par, val, prev):
	return

def onEnableChange(par, val, prev):
	return

def onModeChange(par, val, prev):
	return
	